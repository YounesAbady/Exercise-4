@page
@model IndexModel
<script defer src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function listCategories() {
        return fetch('https://localhost:7018/api/list-categories', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(res => res.json())
            .then(data => {
                return data
            }
            )
    }
    async function listRecipes() {
        return fetch('https://localhost:7018/api/list-recipes/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(res => res.json())
            .then(data => {
                return data
            }
            )
    }
    async function createCategory(category) {
        var url = "https://localhost:7018/api/add-category/"
        url = url + category
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                category: category
            })
        })
            .then(res => {
                return res
            })
        if (response.ok) { return true }
        else { return false }

    }
    async function deleteCategory(category) {
        var url = "https://localhost:7018/api/delete-category/"
        url = url + category
        return fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                category: category
            })
        })
            .then(res => { return res.json() })
    }
    async function editCategory(position, newCategory) {
        var url = "https://localhost:7018/api/update-category/"
        url = url + position + "/" + newCategory
        return fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                newCategory: newCategory
            })
        })
            .then(res => { return res.json() })
    }
    async function createRecipe(recipe) {
        var url = "https://localhost:7018/api/add-recipe/"
        url = url + JSON.stringify(recipe)
        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                jsonRecipe: recipe
            })
        })
            .then(res => { return res.json() })
    }
    async function adjustRecipe(recipe) {
        recipe.ingredients = recipe.ingredients[0].split("\r\n")
        recipe.instructions = recipe.instructions[0].split("\r\n")
        return recipe
    }
    async function deleteRecipe(id) {
        var url = "https://localhost:7018/api/delete-recipe/"
        url = url + id
        return fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: {
                id: id
            }
        })
            .then(res => { return res.json() })
    }
    async function updateRecipe(jsonRecipe, id) {
        var url = "https://localhost:7018/api/update-recipe/"
        url = url + JSON.stringify(jsonRecipe) + "/" + id
        return fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                jsonRecipe: jsonRecipe
            })
        })
            .then(res => { return res.json() })
    }
    async function fromJsonToString(recipe) {
        for (let i = 0; i < recipe.ingredients.length; i++) {
            recipe.ingredients[i] = recipe.ingredients[i].replace(",", "\r\n")
        }
        for (let t = 0; t < recipe.instructions.length; t++) {
            recipe.instructions[t] = recipe.instructions[t].replace(",", "\r\n")
        }
        return recipe
    }
    async function sweetAlert2(msg, status) {
        if (status == "error") {
            await Swal.fire({
                icon: 'error',
                title: msg,
                showConfirmButton: true,
            })
        }
        else {
            await Swal.fire({
                icon: 'success',
                title: msg,
                showConfirmButton: true,
            })
        }

    }
</script>
<style>
    [x-cloak] {
        display: none;
    }
</style>

<div x-data="{ categories: [], recipes:[], expandCategory:false, expandRecipe:false, trigger:false, msg:'',status: '' }">
    <!--Trigger-->
    <template x-if="trigger">
        <div x-init="await sweetAlert2(msg,status)"></div>
    </template>
    <!--Nav Bar-->

    <header>
        <nav class="navbar navbar-expand-lg" style="height:60px; background-color: #252f3e;">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarColor03">
                    <ul class="navbar-nav me-auto">
                        <li style="margin-left:25px;margin-top:20px;">
                            <div class="logo-holder logo-5">
                                <a class="nav-link text-light" asp-page="/Home">
                                    <h3>Yum</h3>
                                    <p>City</p>
                                </a>
                            </div>
                        </li>
                        <li class="nav-item" style="margin-left:1050px;margin-top:20px;">
                            <a x-on:click="categories = await listCategories();expandCategory= !expandCategory;expandRecipe=false " class="btn" style="margin-top:15px;color:white;font-size:large">Categories</a>
                        </li>
                        <li class="nav-item" style="margin-left:50px;margin-top:20px;">
                            <a x-on:click="recipes = await listRecipes();expandRecipe= !expandRecipe;expandCategory=false " class="btn" style="margin-top:15px;color:white;font-size:large">Recipes</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!--Home-->
    <!--List Categories-->

    <div x-data="{ expandCreate:false, chosenCategory:'', expandDelete:false, expandEdit:false,position:-1 }" x-show="expandCategory" x-cloak x-transition>
        <div class="row row-cols-1 row-cols-md-4 g-2 text-center">
            <template x-for="(category, index) in categories">
                <div>
                    <div class="col">
                        <div class="card h-100 text-center" style="background-color:#252f3e;margin-left:2px;margin-top:5px;">
                            <div class="card-body">
                                <h5 x-text="category" class="card-title" style="color:white"></h5>
                                <a x-on:click="chosenCategory= category ;position=index+1;expandEdit= !expandEdit;expandDelete=false;expandCreate=false" class="btn btn-dark" style="background-color:#FF6A3D;color:white;margin-top:10px;"><i class="bi bi-pencil-square" style="font-style:normal"> Edit</i></a>
                                <a x-on:click="chosenCategory= category ;expandDelete= !expandDelete;expandEdit=false;expandCreate=false" class="btn btn-danger" style="color:white;margin-top:10px;"><i class="bi bi-trash" style="font-style:normal"> Delete</i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!--Create Category-->

        <button x-on:click="expandCreate = ! expandCreate" style="background-color:#252f3e;color:#FF6A3D;margin-top:50px;margin-left:45%" class="btn text-center"><i class="bi bi-plus-circle" style="font-style:normal"> Create Category</i></button>

        <div x-show="expandCreate" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <input x-model="chosenCategory" placeholder="Enter category name" type="text" />
                <button x-on:click="trigger=await createCategory(chosenCategory);expandCreate= fasle;expandCategory= false;" class="btn btn-success" style="font-style:normal"> Add</button>
            </form>
        </div>

        <!--Delete Category-->

        <div x-show="expandDelete" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <input x-model="chosenCategory" placeholder="Enter category name" type="text" disabled />
                <button x-on:click="await deleteCategory(chosenCategory);expandDelete= fasle;expandCategory= false" class="btn btn-danger" style="font-style:normal"> Delete</button>
            </form>
        </div>

        <!--Edit Category-->

        <div x-show="expandEdit" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <input x-model="chosenCategory" type="text" />
                <button x-on:click="await editCategory(position,chosenCategory);expandEdit= fasle;expandCategory= false" class="btn btn-success" style="font-style:normal"> Edit</button>
            </form>
        </div>

    </div>

    <!--List Recipes-->

    <div x-data="{ expandCreate:false, chosenRecipe:{Title:'', Ingredients:[], Instructions:[], Categories:[]}, expandDelete:false, expandEdit:false }" x-show="expandRecipe" x-cloak x-transition>
        <div class="row row-cols-1 row-cols-md-4 g-2 text-center">
            <template x-for="recipe in recipes">
                <div class="col">
                    <div class="card h-100 text-center" style="background-color:#252f3e;margin-left:2px;margin-top:5px;">
                        <div class="card-body">
                            <h5 x-text="recipe.title" class="card-title" style="color:white"></h5>
                            <div x-data="{ expanded: false }">
                                <button x-on:click="expanded = ! expanded" style="background-color:#F4DB7D;color:black;margin-top:10px;font-style:normal" class="text-center"><i class="bi bi-search" style="font-style:normal"> Show Ingredients</i></button>
                                <template x-for="ing in recipe.ingredients">
                                    <p x-text="'- '+ing" x-show="expanded" x-collapse class="card-text text-start" x-transition style="color:white"></p>
                                </template>
                            </div>
                            <br>
                            <div x-data="{ expanded: false }">
                                <button x-on:click="expanded = ! expanded" style="background-color:#F4DB7D;color:black;margin-top:10px;font-style:normal" class="text-center"><i class="bi bi-search" style="font-style:normal"> Show Instructions</i></button>
                                <template x-for="ins in recipe.instructions">
                                    <p x-text="'- '+ins" x-show="expanded" x-collapse class="card-text text-start" x-transition style="color:white"></p>
                                </template>
                            </div>
                            <br>
                            <div x-data="{ expanded: false }">
                                <button x-on:click="expanded = ! expanded" style="background-color:#F4DB7D;color:black;margin-top:10px;font-style:normal" class="text-center"><i class="bi bi-search" style="font-style:normal"> Show Categories</i></button>
                                <template x-for="cat in recipe.categories">
                                    <p x-text="'- '+cat" x-show="expanded" x-collapse class="card-text text-start" x-transition style="color:white"></p>
                                </template>
                            </div>
                            <br>
                            <a x-on:click="chosenRecipe= await fromJsonToString(recipe);expandEdit= !expandEdit;expandDelete=false;expandCreate=false" class="btn btn-dark" style="background-color:#FF6A3D;color:white;margin-top:10px;font-style:normal"><i class="bi bi-pencil-square" style="font-style:normal"> Edit</i></a>
                            <a x-on:click="chosenRecipe= recipe ;expandDelete= !expandDelete;expandEdit=false;expandCreate=false" class="btn btn-danger" style="color:white;margin-top:10px;font-style:normal"><i class="bi bi-trash" style="font-style:normal"> Delete</i></a>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!--Create Recipe-->

        <button x-on:click="expandCreate = ! expandCreate" style="background-color:#252f3e;color:#FF6A3D;margin-top:50px;margin-left:45%" class="btn text-center"><i class="bi bi-plus-circle" style="font-style:normal"> Create Recipe</i></button>
        <div x-show="expandCreate" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Recipe Title</label>
                        <input x-model="chosenRecipe.Title" class="form-control">
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Ingredients</label>
                        <textarea x-text="chosenRecipe.Ingredients[0]" placeholder="After every ingredient press enter for new line." rows="5" cols="30"></textarea>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Instructions</label>
                        <textarea x-model="chosenRecipe.Instructions[0]" placeholder="After every instructions press enter for new line." rows="5" cols="30"></textarea>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <form method="post">
                            <label style="font:bolder;text-align:left" class="fw-bold">Choose one or more category</label>
                            <br>
                            <select x-init="categories = await listCategories()" x-model="chosenRecipe.Categories" multiple style="color:black">
                                <template x-for="cat in categories">
                                    <option x-model="cat" value="cat" x-text="cat"></option>
                                </template>
                            </select>
                            <p style="font-weight:bold">Hold down the Ctrl (windows) or Command (Mac) button to select multiple options.</p>
                        </form>
                    </div>
                    <button x-on:click="await createRecipe(chosenRecipe);expandRecipe=false" type="submit" class="btn btn-success"><i class="bi bi-plus-circle-fill" style="font-style:normal"> Create Recipe</i></button>
                    <br><br>
                </div>
            </form>
        </div>

        <!--Delete Recipe-->

        <div x-show="expandDelete" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Recipe Title</label>
                        <input x-model="chosenRecipe.title" class="form-control" disabled>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Ingredients</label>
                        <template x-for="ing in chosenRecipe.ingredients">
                            <input x-model="ing" disabled>
                            <br>
                        </template>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Instructions</label>
                        <template x-for="ins in chosenRecipe.instructions">
                            <input x-model="ins" disabled>
                            <br>
                        </template>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Categories</label>
                        <template x-for="cat in chosenRecipe.categories">
                            <input x-model="cat" disabled>
                            <br>
                        </template>
                    </div>
                    <br>
                    <button x-on:click="await deleteRecipe(chosenRecipe.id);expandDelete= fasle;expandRecipe= false" class="btn btn-danger" style="font-style:normal"> Delete</button>
                </div>
            </form>
        </div>

        <!--Update Recipe-->

        <div x-show="expandEdit" x-cloak x-transition>
            <form method="post" class="align-content-center col-6 " style="margin:auto;text-align:center;margin-top:50px;color:#1A2238">
                <input x-model="chosenRecipe.id" hidden>
                <div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Recipe Title</label>
                        <input x-model="chosenRecipe.title" class="form-control">
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Ingredients</label>
                        <textarea x-model="chosenRecipe.ingredients" placeholder="After every ingredient press enter for new line." rows="4" cols="30"></textarea>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <label style="font:bolder;text-align:left" class="fw-bold">Instructions</label>
                        <textarea x-model="chosenRecipe.instructions" placeholder="After every ingredient press enter for new line." rows="4" cols="30"></textarea>
                    </div>
                    <div class="mt-4 text-dark" style="font-weight:bold;font-size:medium">
                        Old Categories:
                        <template x-for="cat in chosenRecipe.categories">
                            <p x-text="cat"></p>
                        </template>
                        <br>
                        <span class="text-danger" style="font-size:large">All old categories will be deleted!<br> Please select new ones.</span>
                    </div>
                    <div class="row mt-4 col-11 m-auto">
                        <form method="post">
                            <label style="font:bolder;text-align:left" class="fw-bold">Choose one or more category</label>
                            <br>
                            <select x-init="categories = await listCategories()" x-model="chosenRecipe.categories" multiple style="color:black">
                                <template x-for="cat in categories">
                                    <option x-model="cat" value="cat" x-text="cat"></option>
                                </template>
                            </select>
                            <p style="font-weight:bolder">Hold down the Ctrl (windows) or Command (Mac) button to select multiple options.</p>
                        </form>
                    </div>
                    <br>
                    <button x-on:click="chosenRecipe = await adjustRecipe(chosenRecipe);await updateRecipe(chosenRecipe,chosenRecipe.id);expandEdit= fasle;expandRecipe= false" class="btn btn-danger" style="font-style:normal"> Edit</button>
                </div>
            </form>
        </div>
    </div>
</div>
